<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseUrl = "https://kxscsimitzauzpgddoqq.supabase.co";
const supabaseKey = "sb_publishable_rVLHZNN_yKqtKXhapONxrA_waMS-Hf2";

const supabaseClient = window.supabase.createClient(
  supabaseUrl,
  supabaseKey
);

document.getElementById("btnSubir").onclick = async function () {

  const { data: authData } = await supabaseClient.auth.getUser();
  if (!authData.user) return alert("Debes iniciar sesi√≥n.");

  const uid = authData.user.id;
  const tipo = document.getElementById("tipoDocumento").value;
  const file = document.getElementById("fileInput").files[0];

  if (!file) return alert("Selecciona un archivo");

  const nombre = `${uid}/${Date.now()}-${file.name}`;

  const { error: uploadError } = await supabaseClient.storage
    .from("documentos")
    .upload(nombre, file);

  if (uploadError) {
    console.error(uploadError);
    return alert("Error al subir archivo");
  }

  const { data: urlData } = supabaseClient.storage
    .from("documentos")
    .getPublicUrl(nombre);

  await supabaseClient.from("users_docs").insert({
    user_id: uid,
    tipo,
    file_url: urlData.publicUrl,
    estado: "pendiente",
    observacion: ""
  });

  alert("Documento subido correctamente");
};

async function cerrarSesion() {
  await supabaseClient.auth.signOut();
  window.location.href = "index.html";
}
</script>
